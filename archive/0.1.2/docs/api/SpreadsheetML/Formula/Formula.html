<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Formula Processing | OpenLanguage Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Formula Processing | OpenLanguage Documentation ">
      
      
      <link rel="icon" href="../../../../favicon.ico">
      <link rel="stylesheet" href="../../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../../public/main.css">
      <meta name="docfx:navrel" content="../../../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/amkillam/OpenLanguage/blob/main/build/docs/docs/api/SpreadsheetML/Formula/Formula.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../../index.html">
            <img id="logo" class="svg" src="../../../../img/logo.png" alt="OpenLanguage">
            OpenLanguage
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="formula-processing">Formula Processing</h1>

<p>The <code>OpenLanguage.SpreadsheetML.Formula</code> namespace provides Excel formula parsing capabilities using GPLEX/GPPG-generated lexer and parser.</p>
<h2 id="overview">Overview</h2>
<p>The Formula component offers:</p>
<ul>
<li><strong>Excel Formula Parsing</strong>: Parse Excel formulas into Abstract Syntax Trees (AST)</li>
<li><strong>Grammar-Based Parsing</strong>: Uses GPLEX lexer (.lex) and GPPG parser (.y) for robust parsing</li>
<li><strong>AST Manipulation</strong>: Access and modify parsed formula structures programmatically</li>
<li><strong>Formula Reconstruction</strong>: Convert ASTs back to valid Excel formula strings</li>
</ul>
<h2 id="core-classes">Core Classes</h2>
<h3 id="formulaparser">FormulaParser</h3>
<p>Static class providing the main entry point for formula parsing operations.</p>
<pre><code class="lang-csharp">using OpenLanguage.SpreadsheetML.Formula;

// Parse a formula
var formula = FormulaParser.Parse(&quot;=SUM(A1:A10) * 2&quot;);

// Try parsing with error handling
var maybeFormula = FormulaParser.TryParse(&quot;=INVALID_SYNTAX(&quot;);
</code></pre>
<h4 id="methods">Methods</h4>
<ul>
<li><code>Parse(string formulaText)</code> - Parses a formula string and returns a Formula object</li>
<li><code>TryParse(string formulaText)</code> - Attempts to parse, returns null on failure</li>
</ul>
<h2 id="parser-implementation">Parser Implementation</h2>
<p>The formula parser is built using GPLEX/GPPG tools:</p>
<h3 id="grammar-files">Grammar Files</h3>
<ul>
<li><strong>Lexer</strong>: <code>SpreadsheetML/Formula/Lang/Lex/formula.lex</code> - Tokenizes formula text</li>
<li><strong>Parser</strong>: <code>SpreadsheetML/Formula/Lang/Parse/formula.y</code> - Defines grammar rules</li>
</ul>
<h3 id="supported-syntax">Supported Syntax</h3>
<p>Based on the test cases, the parser supports:</p>
<h4 id="literals-and-identifiers">Literals and Identifiers</h4>
<ul>
<li>Numbers: <code>123</code></li>
<li>Strings: <code>&quot;hello&quot;</code></li>
<li>Booleans: <code>TRUE</code>, <code>FALSE</code></li>
<li>Errors: <code>#VALUE!</code></li>
<li>Cell references: <code>A1</code></li>
<li>Named ranges: <code>MyNamedRange</code></li>
</ul>
<h4 id="binary-operations">Binary Operations</h4>
<ul>
<li>Arithmetic: <code>1+2*3</code>, <code>(1+2)*3</code>, <code>10/2*5</code></li>
<li>Power: <code>2^3^2</code> (right-associative)</li>
<li>Range operations: <code>A1:B2 C3:D4</code> (intersection), <code>A1:B2,C3:D4</code> (union)</li>
</ul>
<h4 id="unary-operations">Unary Operations</h4>
<ul>
<li>Negative: <code>-5</code></li>
<li>Positive: <code>+A1</code></li>
<li>Applied to ranges: <code>-A1:B2</code></li>
</ul>
<h4 id="function-calls">Function Calls</h4>
<ul>
<li>Basic: <code>SUM(1, 2, 3)</code></li>
<li>Nested: <code>IF(A1&gt;B1, &quot;Yes&quot;, &quot;No&quot;)</code></li>
<li>With references: <code>VLOOKUP(A1, Sheet2!A:B, 2, FALSE)</code></li>
</ul>
<h4 id="array-literals">Array Literals</h4>
<ul>
<li>Row arrays: <code>{1,2,3}</code></li>
<li>Column arrays: <code>{1;2;3}</code></li>
<li>2D arrays: <code>{&quot;a&quot;,&quot;b&quot;;&quot;c&quot;,&quot;d&quot;}</code></li>
</ul>
<h4 id="advanced-references">Advanced References</h4>
<ul>
<li>Table references: <code>Table1[@Column1]</code></li>
</ul>
<h4 id="example-usage">Example Usage</h4>
<pre><code class="lang-csharp">// Parse various formula types
var literal = FormulaParser.Parse(&quot;123&quot;);
var arithmetic = FormulaParser.Parse(&quot;1+2*3&quot;);
var function = FormulaParser.Parse(&quot;SUM(A1:A10)&quot;);
var complex = FormulaParser.Parse(&quot;IF(A1&gt;B1, &quot;Yes&quot;, &quot;No&quot;)&quot;);
</code></pre>
<h2 id="error-handling">Error Handling</h2>
<p>The parser throws <code>InvalidOperationException</code> for syntax errors:</p>
<pre><code class="lang-csharp">try
{
    var formula = FormulaParser.Parse(&quot;=SUM(1,&quot;);  // Missing closing parenthesis
}
catch (InvalidOperationException ex)
{
    Console.WriteLine($&quot;Parse error: {ex.Message}&quot;);
}

// Or use TryParse for error handling
var maybeFormula = FormulaParser.TryParse(&quot;=INVALID_SYNTAX(&quot;);
if (maybeFormula == null)
{
    Console.WriteLine(&quot;Parse failed&quot;);
}
</code></pre>
<h2 id="ast-manipulation">AST Manipulation</h2>
<p>The parsed AST can be modified and reconstructed:</p>
<pre><code class="lang-csharp">var formula = FormulaParser.Parse(&quot;=A1+B1&quot;);

// Access the AST
var astRoot = formula;

// Modify the AST (implementation-specific)
// ...

// Reconstruct the formula
var reconstructed = formula.ToString(); // Uses AstRoot.ToString()
</code></pre>
<h2 id="build-process">Build Process</h2>
<p>The grammar files are processed during build:</p>
<ol>
<li><code>formula.lex</code> is processed by GPLEX to generate the lexer</li>
<li><code>formula.y</code> is processed by GPPG to generate the parser</li>
<li>Generated code is placed in the <code>Generated/</code> directory</li>
<li>The build system uses CMake to orchestrate this process</li>
</ol>
<h2 id="examples">Examples</h2>
<h3 id="basic-usage">Basic Usage</h3>
<pre><code class="lang-csharp">using OpenLanguage.SpreadsheetML.Formula;

// Parse a simple formula
var formula = FormulaParser.Parse(&quot;=1+2*3&quot;);
Console.WriteLine($&quot;Reconstructed: {formula.ToString()}&quot;);

// Parse with functions
var funcFormula = FormulaParser.Parse(&quot;=SUM(A1:A10)&quot;);
Console.WriteLine($&quot;Function formula: {funcFormula}&quot;);
</code></pre>
<h3 id="error-handling-1">Error Handling</h3>
<pre><code class="lang-csharp">// Handle parse errors gracefully
var result = FormulaParser.TryParse(&quot;=SUM(1,&quot;); // Invalid syntax

if (result != null)
{
    Console.WriteLine(&quot;Parsed successfully&quot;);
}
else
{
    Console.WriteLine(&quot;Parse failed - check syntax&quot;);
}
</code></pre>
<h3 id="working-with-asts">Working with ASTs</h3>
<pre><code class="lang-csharp">var formula = FormulaParser.Parse(&quot;=A1+B1&quot;);

// The AstRoot property gives access to the parsed tree structure
var root = formula;

// Convert back to string representation
var reconstructed = root.ToString();
Console.WriteLine($&quot;Reconstructed: {reconstructed}&quot;);
</code></pre>
<h2 id="technical-details">Technical Details</h2>
<ul>
<li>Uses GPLEX for lexical analysis and GPPG for parsing</li>
<li>Generates C# code from .lex and .y grammar files</li>
<li>Supports Excel formula syntax including functions, operators, and references</li>
<li>AST nodes implement ToString() for formula reconstruction</li>
<li>Thread-safe static parsing methods</li>
</ul>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/amkillam/OpenLanguage/blob/main/build/docs/docs/api/SpreadsheetML/Formula/Formula.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
